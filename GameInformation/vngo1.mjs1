import axios from "axios";
import moment from "moment-timezone";

// å‘é€è®¡åˆ’çš„é¢‘é“
const channelUsername = "@gameresult";

const gameResults = [];
let previousResults = null;

// è·å–å°åº¦æ—¶é—´
const getIndiaTime = async () => {
  try {
    const response = await axios.get('http://worldtimeapi.org/api/timezone/Asia/Kolkata');
    return response.data.datetime; // è¿”å›å°åº¦æ—¶é—´
  } catch (error) {
    console.error('è·å–å°åº¦æ—¶é—´æ—¶å‡ºé”™:', error);
    return moment().tz("Asia/Kolkata").format(); // ä½œä¸ºå¤‡ç”¨ï¼Œä½¿ç”¨æœ¬åœ°æ—¶é—´
  }
};

// è·å–æ¸¸æˆç»“æœ
const getGameResults = async () => {
  const url = "https://lottstars.com/result/getResult";
  const currentDate = await getIndiaTime(); // è·å–å½“å‰å°åº¦æ—¶é—´

  try {
    const response = await axios.get(url, {
      params: {
        game: "vngo1",
        date: currentDate.split("T")[0], 
        page: 1,
        limit: 10,
      },
    });
    if (gameResults.length > 0) {
      // æ›´æ–°é¢„æµ‹ç»“æœ
      await updateForecastResults(response.data.data.list[0]);
    }
    return response.data;
  } catch (error) {
    console.error("è·å–æ¸¸æˆç»“æœæ—¶å‡ºé”™:", error);
    return { data: { list: [] } };
  }
};

// è‡ªåŠ¨æ¨é€åŠŸèƒ½
const sendResults_vngo1 = async (bot) => {
  let results = await getGameResults();

  if (
    (previousResults &&
      JSON.stringify(results) === JSON.stringify(previousResults)) ||
    results.length < 0
  ) {
    console.log("ç»“æœä¸ä¸Šæ¬¡ç›¸åŒï¼Œè¿”å›");
    return;
  }

  previousResults = results;

  if (results.data.list.length === 0) {
    console.log("æ²¡æœ‰è·å–åˆ°æ¸¸æˆç»“æœ");
    return;
  }

  const latestResult = results.data.list[0];
  const latestPeriod = latestResult.period;
  const nextPrediction = predictNextResult(latestPeriod);

  if (!gameResults.some((result) => result.period === nextPrediction.period)) {
    gameResults.unshift(nextPrediction);
    if (gameResults.length > 10) {
      gameResults.pop();
    }
  }
  const message = formatMessage(gameResults);
  bot.sendMessage(channelUsername, message, { parse_mode: "HTML" });
};

// éšæœºé¢„æµ‹ä¸‹ä¸€æœŸçš„æ•°æ®
const predictNextResult = (currentPeriod) => {
  const options = ["Red", "Green", "Purple", "Big", "Small"];
  const bs = options[Math.floor(Math.random() * options.length)];
  return {
    period: String(parseInt(currentPeriod) + 1),
    bs: bs,
    predictOutcome: "",
  };
};

// æ›´æ–°é¢„æµ‹ç»“æœ
const updateForecastResults = async (data) => {
  try {
    if (!gameResults.length) {
      console.error("gameResults æ•°ç»„ä¸ºç©º");
      return;
    }

    if (data.period === gameResults[0].period) {
      const openNum = data.open_num[0];
      let result = "LOSE";

      if (gameResults[0].bs === "Red" && [0, 2, 4, 6, 8].includes(openNum)) {
        result = openNum === 0 ? "WIN " : "WIN";
      } else if (
        gameResults[0].bs === "Green" &&
        [1, 3, 5, 7, 9].includes(openNum)
      ) {
        result = openNum === 5 ? "WIN " : "WIN";
      } else if (gameResults[0].bs === "Purple" && [0, 5].includes(openNum)) {
        result = "WIN";
      } else if (gameResults[0].bs === "Big" && openNum >= 5) {
        result = "WIN";
      } else if (gameResults[0].bs === "Small" && openNum <= 4) {
        result = "WIN";
      }

      gameResults[0].predictOutcome = result;
    } else {
      return;
    }
  } catch (error) {
    console.error("æ›´æ–°å‡ºé”™:", error);
  }
};

// æ ¼å¼åŒ–æ¶ˆæ¯
const formatMessage = (results) => {
  let message = "============\nWinGo 1Min - TC\n============\n";
  results
    .slice()
    .reverse()
    .forEach((result) => {
      const outcome = result.predictOutcome ? ` ${result.predictOutcome}` : "";
      const period = result.period.slice(-3);
      message += `${period} 1 MINã€${result.bs.toUpperCase()}ã€‘${outcome}\n`;
    });
  message += `============\n\nAdmin assist ï¼šhttps://t.me/TCofficial_Priyanka\n\nIf You have any inquiries or issues \nTC Customer Support link: \n======================\nhttps://tcsupport.in/#/\n======================\nâš ï¸Claim your Win streak Bonus âš ï¸\nğŸ’¯DOUBLE Bonus ( 1 AM - 7 AM Daily ) ğŸ’¯\n======================\nOfficial TC website link :\ntcgames.app\n`;
  return message;
};

export { sendResults_vngo1 };
